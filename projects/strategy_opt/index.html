<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Trading Strategy Optimization | Tommaso de Martino </title> <meta name="author" content="Tommaso de Martino"> <meta name="description" content="This is the procedure I adopt to optimize a strategy and avoid Overfitting"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.png?1d8de0bac7da496e8c69cdbb6842c663"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://tdistudent27.github.io/projects/strategy_opt/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Tommaso de Martino </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">Projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Trading Strategy Optimization</h1> <p class="post-description">This is the procedure I adopt to optimize a strategy and avoid Overfitting</p> </header> <article> <h2 id="libraries">Libraries</h2> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">vectorbt</span> <span class="k">as</span> <span class="n">vbt</span>
<span class="kn">import</span> <span class="n">ta</span>
<span class="kn">from</span> <span class="n">ta.trend</span> <span class="kn">import</span> <span class="n">SMAIndicator</span><span class="p">,</span> <span class="n">ADXIndicator</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="n">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">import</span> <span class="n">time</span>  

</code></pre></div></div> <h2 id="data">Data</h2> <p>To <strong>backtest a strategy in python</strong> I use 2 version of the same dataset.</p> <ol> <li> <p>The <code class="language-plaintext highlighter-rouge">timerframe</code> the strategy is based on</p> </li> <li> <p>A lower <code class="language-plaintext highlighter-rouge">timeframe</code> to have a more precise indications of the development of the candle</p> </li> </ol> <blockquote> <p>Example:</p> <p>In this case the strategy is based on H4 candles. Using this timeframe I will compute the signals. Suppose a position is taken at <code class="language-plaintext highlighter-rouge">9am</code> and a <strong>Take Profit (TP)</strong> and a <strong>Stop Loss (SL)</strong> are set at some levels. The next candle reaches <strong>both the TP and the SL</strong>, so is it a loss or a profit?</p> <p>I will need the lower timeframe (e.g 1 minute candles in this case) to understand if the Take Proftit or the Stop Loss came first. This is the the closer approach to a real word environment to backtest a strategy.</p> <p>Obviously, the lower the <code class="language-plaintext highlighter-rouge">timeframe</code>, the more precision I will have</p> </blockquote> <p>This is my dataset</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">H4 dataset:</span><span class="se">\n</span><span class="s"> </span><span class="si">{</span><span class="n">df_4h</span><span class="si">}</span><span class="se">\n</span><span class="s"> 1m dataset</span><span class="se">\n</span><span class="si">{</span><span class="n">df_1m</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>H4 dataset:
                         open     high      low    close  tickvol
datetime                                                        
2017-07-21 16:00:00  1.16400  1.16702  1.16358  1.16660    31730
2017-07-21 20:00:00  1.16662  1.16827  1.16612  1.16634    20497
2017-07-24 00:00:00  1.16599  1.16842  1.16599  1.16709    12678
2017-07-24 04:00:00  1.16708  1.16753  1.16631  1.16708     9686
2017-07-24 08:00:00  1.16709  1.16751  1.16302  1.16529    35881
...                      ...      ...      ...      ...      ...
2025-07-08 08:00:00  1.17416  1.17653  1.17319  1.17490    15925
2025-07-08 12:00:00  1.17489  1.17506  1.17140  1.17211    15208
2025-07-08 16:00:00  1.17210  1.17222  1.16827  1.17088    23138
2025-07-08 20:00:00  1.17088  1.17298  1.17075  1.17244    11899
2025-07-09 00:00:00  1.17199  1.17293  1.17142  1.17246     5627

[12382 rows x 5 columns]

1m dataset
                        open     high      low    close  tickvol
datetime                                                        
2017-07-21 12:45:00  1.16470  1.16480  1.16460  1.16476      146
2017-07-21 12:46:00  1.16475  1.16480  1.16469  1.16472      162
2017-07-21 12:47:00  1.16472  1.16486  1.16468  1.16485      150
2017-07-21 12:48:00  1.16484  1.16484  1.16469  1.16479      174
2017-07-21 12:49:00  1.16480  1.16481  1.16456  1.16463      208
...                      ...      ...      ...      ...      ...
2025-07-08 23:55:00  1.17253  1.17257  1.17251  1.17257       19
2025-07-08 23:56:00  1.17257  1.17268  1.17253  1.17267       28
2025-07-08 23:57:00  1.17267  1.17267  1.17254  1.17257       23
2025-07-08 23:58:00  1.17257  1.17257  1.17243  1.17245       22
2025-07-08 23:59:00  1.17245  1.17247  1.17239  1.17244       20

[2966785 rows x 5 columns]
</code></pre></div></div> <h2 id="parameters">Parameters</h2> <p>This strategy open positions based on some parameters:</p> <ul> <li> <p>Simple moving Average 1 (SMA1)</p> </li> <li> <p>SMA 2</p> </li> <li> <p>Average Directional Index (ADX)</p> </li> <li> <p>ADX Max: a threshold that filters positions</p> </li> </ul> <blockquote> <p>WARNING: For obvious reasons, I will not disclose the exact signal-generation logic of my strategy.</p> <p>However, I will provide the parameter grid used for the optimization process.</p> </blockquote> <p>Simply generate a code that adds a <code class="language-plaintext highlighter-rouge">signal</code> column to the main timeframe of the strategy (4H my case), which takes the value <code class="language-plaintext highlighter-rouge">1</code> for <code class="language-plaintext highlighter-rouge">long</code> positions, <code class="language-plaintext highlighter-rouge">-1</code> for <code class="language-plaintext highlighter-rouge">short</code> positions, and <code class="language-plaintext highlighter-rouge">0</code> otherwise.</p> <p>Additionally, I will apply a time filter, as the original study was conducted over this specific period:</p> <ul> <li> <p>Start: <code class="language-plaintext highlighter-rouge">2022-05-19</code></p> </li> <li> <p>End: <code class="language-plaintext highlighter-rouge">2025-07-09</code></p> </li> </ul> <p>This is the result:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                        open     high      low    close  tickvol      sma1  \
datetime                                                                     
2022-05-19 00:00:00  1.04683  1.05006  1.04612  1.04884    11808  1.049522   
2022-05-19 04:00:00  1.04884  1.05068  1.04789  1.04963    16846  1.049998   
2022-05-19 08:00:00  1.04963  1.05090  1.04649  1.04964    28109  1.050408   
2022-05-19 12:00:00  1.04964  1.05451  1.04872  1.05377    36015  1.051011   
2022-05-19 16:00:00  1.05377  1.05986  1.05366  1.05934    56746  1.052029   
...                      ...      ...      ...      ...      ...       ...   
2025-07-08 08:00:00  1.17416  1.17653  1.17319  1.17490    15925  1.175075   
2025-07-08 12:00:00  1.17489  1.17506  1.17140  1.17211    15208  1.174769   
2025-07-08 16:00:00  1.17210  1.17222  1.16827  1.17088    23138  1.174295   
2025-07-08 20:00:00  1.17088  1.17298  1.17075  1.17244    11899  1.173959   
2025-07-09 00:00:00  1.17199  1.17293  1.17142  1.17246     5627  1.173679   

                         sma2        adx  signal  
datetime                                          
2022-05-19 00:00:00  1.051903  13.630782       0  
2022-05-19 04:00:00  1.051437  13.577530       0  
2022-05-19 08:00:00  1.050971  13.551828       0  
2022-05-19 12:00:00  1.050879  13.442523       0  
2022-05-19 16:00:00  1.051263  13.220664       0  
...                       ...        ...     ...  
2025-07-08 08:00:00  1.173984  19.680101       0  
2025-07-08 12:00:00  1.173503  19.458087       0  
2025-07-08 16:00:00  1.172791  19.161909       0  
2025-07-08 20:00:00  1.172373  18.888370       0  
2025-07-09 00:00:00  1.172375  18.619805       0  

[4880 rows x 9 columns]
</code></pre></div></div> <h2 id="backtest">Backtest</h2> <p>In addition to the signal-generation parameters, the strategy also includes risk management parameters:</p> <p><code class="language-plaintext highlighter-rouge">risk_pct</code> = Percentage of the equity to risk on each trade if the stop-loss is hit.</p> <p><code class="language-plaintext highlighter-rouge">extra_pips</code> = Additional “breathing room” in pips given to the stop-loss.</p> <p><code class="language-plaintext highlighter-rouge">tp_multiplier</code> = Take-profit target expressed as a multiple of the stop-loss distance.</p> <p>After the best parameters over the grid have been found, the backes function will be something like this (some values have been included due to my personal experience in strategies like this):</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">sma1_window</span><span class="sh">'</span>   <span class="p">:</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">],</span>
    <span class="sh">'</span><span class="s">sma2_window</span><span class="sh">'</span>   <span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">],</span>
    <span class="sh">'</span><span class="s">adx_window</span><span class="sh">'</span>    <span class="p">:</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">55</span><span class="p">],</span>
    <span class="sh">'</span><span class="s">adx_max</span><span class="sh">'</span>       <span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mf">13.5</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span>
    <span class="sh">'</span><span class="s">risk_pct</span><span class="sh">'</span>      <span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span>
    <span class="sh">'</span><span class="s">extra_pips</span><span class="sh">'</span>    <span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">],</span>
    <span class="sh">'</span><span class="s">tp_multiplier</span><span class="sh">'</span> <span class="p">:</span> <span class="p">[</span><span class="mf">1.3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># 1) GENERATE ALL COMBINATIONS
</span><span class="n">param_combos</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">product</span><span class="p">(</span><span class="o">*</span><span class="n">param_grid</span><span class="p">.</span><span class="nf">values</span><span class="p">()))</span>
<span class="n">TOTAL_COMBOS</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">param_combos</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Total combinations to test: </span><span class="si">{</span><span class="n">TOTAL_COMBOS</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Total combinations to test: 972
</code></pre></div></div> <p>The optimization function is straightforward: it simply loops through each parameter combination, runs the backtest, and returns the combination associated with the chosen optimization metric. In my case, I selected the final equity.</p> <blockquote> <p>NOTE:</p> <p>The backtest already accounts for swaps and commisions</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ── DATA ───────────────────────────────────────────────────────────────────
</span><span class="n">h4</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>           <span class="c1"># already contains the 'signal' column (+1 / –1 / 0)
</span><span class="n">m1</span> <span class="o">=</span> <span class="n">df_1m</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>

<span class="c1"># ── RUNTIME STATE ──────────────────────────────────────────────────────────
</span><span class="n">equity</span>            <span class="o">=</span> <span class="n">init_equity</span>
<span class="n">open_trade</span>        <span class="o">=</span> <span class="bp">None</span>
<span class="n">blocked_until</span>     <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">Timestamp</span><span class="p">.</span><span class="nb">min</span>
<span class="n">trades</span><span class="p">,</span> <span class="n">curve</span>     <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">round_lot</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="nf">max</span><span class="p">(</span><span class="n">min_lot</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">min_lot</span><span class="p">)</span> <span class="o">*</span> <span class="n">min_lot</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">nightly_swap_cash</span><span class="p">(</span><span class="n">entry_ts</span><span class="p">,</span> <span class="n">exit_ts</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span> <span class="n">dir_</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Total overnight swap (€) between entry and exit.</span><span class="sh">"""</span>
    <span class="n">first_night</span> <span class="o">=</span> <span class="n">entry_ts</span><span class="p">.</span><span class="nf">normalize</span><span class="p">()</span> <span class="o">+</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">last_night</span>  <span class="o">=</span> <span class="n">exit_ts</span><span class="p">.</span><span class="nf">normalize</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">exit_ts</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">==</span> <span class="n">pd</span><span class="p">.</span><span class="n">Timestamp</span><span class="p">.</span><span class="nb">min</span><span class="p">.</span><span class="nf">time</span><span class="p">():</span>
        <span class="n">last_night</span> <span class="o">-=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">first_night</span> <span class="o">&gt;</span> <span class="n">last_night</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="n">nights</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">date_range</span><span class="p">(</span><span class="n">first_night</span><span class="p">,</span> <span class="n">last_night</span><span class="p">,</span>
                           <span class="n">freq</span><span class="o">=</span><span class="sh">'</span><span class="s">D</span><span class="sh">'</span><span class="p">,</span> <span class="n">inclusive</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nights</span><span class="p">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="n">nightly_eur</span> <span class="o">=</span> <span class="n">swap_long_eur</span> <span class="k">if</span> <span class="n">dir_</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">swap_short_eur</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">nights</span><span class="p">:</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">nightly_eur</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">.</span><span class="n">dayofweek</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>            <span class="c1"># Wednesday ⇒ +2 extra nights
</span>            <span class="n">total</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nightly_eur</span>
    <span class="k">return</span> <span class="n">total</span> <span class="o">*</span> <span class="n">lots</span>

<span class="c1"># ── 4-HOUR LOOP ────────────────────────────────────────────────────────────
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">h4</span><span class="p">)):</span>
    <span class="n">row</span><span class="p">,</span> <span class="n">prev1</span><span class="p">,</span> <span class="n">prev2</span> <span class="o">=</span> <span class="n">h4</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">h4</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">h4</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="nf">if </span><span class="p">(</span><span class="n">row</span><span class="p">.</span><span class="n">name</span> <span class="o">&lt;</span> <span class="n">blocked_until</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">open_trade</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="sh">'</span><span class="s">signal</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">continue</span>

    <span class="n">dir_</span>     <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="sh">'</span><span class="s">signal</span><span class="sh">'</span><span class="p">])</span>        <span class="c1"># +1 BUY, –1 SELL
</span>    <span class="n">entry_ts</span> <span class="o">=</span> <span class="n">row</span><span class="p">.</span><span class="n">name</span>
    <span class="n">entry_px</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">]</span>

    <span class="c1"># Stop-loss price: previous 2 lows for long, previous 2 highs for short
</span>    <span class="n">sl_px</span> <span class="o">=</span> <span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">prev1</span><span class="p">[</span><span class="sh">'</span><span class="s">low</span><span class="sh">'</span><span class="p">],</span> <span class="n">prev2</span><span class="p">[</span><span class="sh">'</span><span class="s">low</span><span class="sh">'</span><span class="p">])</span> <span class="o">-</span> <span class="n">extra_pips</span> <span class="o">*</span> <span class="n">pip_size</span>
             <span class="k">if</span> <span class="n">dir_</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span>
             <span class="nf">max</span><span class="p">(</span><span class="n">prev1</span><span class="p">[</span><span class="sh">'</span><span class="s">high</span><span class="sh">'</span><span class="p">],</span> <span class="n">prev2</span><span class="p">[</span><span class="sh">'</span><span class="s">high</span><span class="sh">'</span><span class="p">])</span> <span class="o">+</span> <span class="n">extra_pips</span> <span class="o">*</span> <span class="n">pip_size</span><span class="p">)</span>
    <span class="n">sl_pips</span> <span class="o">=</span> <span class="nf">abs</span><span class="p">(</span><span class="n">entry_px</span> <span class="o">-</span> <span class="n">sl_px</span><span class="p">)</span> <span class="o">/</span> <span class="n">pip_size</span>
    <span class="k">if</span> <span class="n">sl_pips</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="c1"># —— Adaptive lot sizing (risk + margin) ————————————————
</span>    <span class="c1"># Desired lot size based on risk management
</span>    <span class="n">lots_risk</span> <span class="o">=</span> <span class="nf">round_lot</span><span class="p">((</span><span class="n">equity</span> <span class="o">*</span> <span class="n">risk_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sl_pips</span> <span class="o">*</span> <span class="n">pip_value</span><span class="p">))</span>

    <span class="c1"># Maximum lot size allowed by available margin
</span>    <span class="n">lots_max_margin</span> <span class="o">=</span> <span class="nf">round_lot</span><span class="p">((</span><span class="n">equity</span> <span class="o">*</span> <span class="n">leverage</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">entry_px</span> <span class="o">*</span> <span class="mi">100_000</span><span class="p">))</span>

    <span class="n">lots</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">lots_risk</span><span class="p">,</span> <span class="n">lots_max_margin</span><span class="p">,</span> <span class="n">max_lot</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lots</span> <span class="o">&lt;</span> <span class="n">min_lot</span><span class="p">:</span>
        <span class="k">continue</span>            <span class="c1"># No trade possible → skip
</span>
    <span class="n">tp_px</span> <span class="o">=</span> <span class="n">entry_px</span> <span class="o">+</span> <span class="n">dir_</span> <span class="o">*</span> <span class="n">sl_pips</span> <span class="o">*</span> <span class="n">pip_size</span> <span class="o">*</span> <span class="n">tp_multiplier</span>
    <span class="n">open_trade</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">dir_</span><span class="p">,</span>
                      <span class="n">entry_ts</span><span class="o">=</span><span class="n">entry_ts</span><span class="p">,</span> <span class="n">entry</span><span class="o">=</span><span class="n">entry_px</span><span class="p">,</span>
                      <span class="n">sl_px</span><span class="o">=</span><span class="n">sl_px</span><span class="p">,</span> <span class="n">tp_px</span><span class="o">=</span><span class="n">tp_px</span><span class="p">)</span>

    <span class="c1"># —— Scan minute bars until TP or SL is hit ————————————————
</span>    <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">bar</span> <span class="ow">in</span> <span class="n">m1</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">entry_ts</span><span class="p">:].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:].</span><span class="nf">iterrows</span><span class="p">():</span>
        <span class="n">hit_tp</span> <span class="o">=</span> <span class="p">(</span><span class="n">dir_</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">bar</span><span class="p">[</span><span class="sh">'</span><span class="s">high</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">tp_px</span><span class="p">)</span> <span class="ow">or</span> \
                 <span class="p">(</span><span class="n">dir_</span> <span class="o">==-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">bar</span><span class="p">[</span><span class="sh">'</span><span class="s">low</span><span class="sh">'</span><span class="p">]</span>  <span class="o">&lt;=</span> <span class="n">tp_px</span><span class="p">)</span>
        <span class="n">hit_sl</span> <span class="o">=</span> <span class="p">(</span><span class="n">dir_</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">bar</span><span class="p">[</span><span class="sh">'</span><span class="s">low</span><span class="sh">'</span><span class="p">]</span>  <span class="o">&lt;=</span> <span class="n">sl_px</span><span class="p">)</span> <span class="ow">or</span> \
                 <span class="p">(</span><span class="n">dir_</span> <span class="o">==-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">bar</span><span class="p">[</span><span class="sh">'</span><span class="s">high</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">sl_px</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">hit_tp</span> <span class="ow">or</span> <span class="n">hit_sl</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">exit_px</span>  <span class="o">=</span> <span class="n">tp_px</span> <span class="k">if</span> <span class="n">hit_tp</span> <span class="k">else</span> <span class="n">sl_px</span>
        <span class="n">pips</span>     <span class="o">=</span> <span class="p">(</span><span class="n">exit_px</span> <span class="o">-</span> <span class="n">entry_px</span><span class="p">)</span> <span class="o">/</span> <span class="n">pip_size</span> <span class="o">*</span> <span class="n">dir_</span>
        <span class="n">gross_pl</span> <span class="o">=</span> <span class="n">pips</span> <span class="o">*</span> <span class="n">lots</span> <span class="o">*</span> <span class="n">pip_value</span>

        <span class="n">commission</span> <span class="o">=</span> <span class="n">lots</span> <span class="o">*</span> <span class="n">commission_per_lot</span>
        <span class="n">swap_cash</span>  <span class="o">=</span> <span class="nf">nightly_swap_cash</span><span class="p">(</span><span class="n">entry_ts</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span> <span class="n">dir_</span><span class="p">)</span>

        <span class="n">pl_cash</span> <span class="o">=</span> <span class="n">gross_pl</span> <span class="o">-</span> <span class="n">commission</span> <span class="o">+</span> <span class="n">swap_cash</span>
        <span class="n">equity</span> <span class="o">+=</span> <span class="n">pl_cash</span>

        <span class="n">trades</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="o">**</span><span class="n">open_trade</span><span class="p">,</span>
                       <span class="sh">'</span><span class="s">exit_ts</span><span class="sh">'</span><span class="p">:</span> <span class="n">ts</span><span class="p">,</span> <span class="sh">'</span><span class="s">exit</span><span class="sh">'</span><span class="p">:</span> <span class="n">exit_px</span><span class="p">,</span>
                       <span class="sh">'</span><span class="s">pips</span><span class="sh">'</span><span class="p">:</span> <span class="n">pips</span><span class="p">,</span> <span class="sh">'</span><span class="s">pl</span><span class="sh">'</span><span class="p">:</span> <span class="n">pl_cash</span><span class="p">,</span>
                       <span class="sh">'</span><span class="s">equity_after</span><span class="sh">'</span><span class="p">:</span> <span class="n">equity</span><span class="p">})</span>
        <span class="n">curve</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">ts</span><span class="p">,</span> <span class="n">equity</span><span class="p">))</span>

        <span class="n">open_trade</span>    <span class="o">=</span> <span class="bp">None</span>
        <span class="n">blocked_until</span> <span class="o">=</span> <span class="n">ts</span>               <span class="c1"># Don't open a new trade until this candle closes
</span>        <span class="k">break</span>

    <span class="k">if</span> <span class="n">equity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Equity depleted – stop back-test</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">break</span>

<span class="c1"># ── RESULTS ────────────────────────────────────────────────────────────────
</span><span class="n">trades_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span>
<span class="n">equity_curve</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">curve</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">equity</span><span class="sh">'</span><span class="p">])</span>
                <span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">sort_index</span><span class="p">())</span>

<span class="nf">print</span><span class="p">(</span><span class="n">trades_df</span><span class="p">.</span><span class="nf">tail</span><span class="p">())</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Initial Equity:</span><span class="sh">"</span> <span class="mi">100</span><span class="p">,)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Final equity:</span><span class="sh">"</span><span class="p">,</span> <span class="n">equity</span><span class="p">)</span>

</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     lots  dir            entry_ts    entry    sl_px     tp_px  \
325  50.0   -1 2025-06-06 00:00:00  1.14429  1.14991  1.136984   
326  50.0   -1 2025-06-12 00:00:00  1.14825  1.15035  1.145520   
327  50.0   -1 2025-06-12 08:00:00  1.15151  1.15332  1.149157   
328  50.0   -1 2025-06-12 20:00:00  1.15761  1.16356  1.149875   
329  50.0   -1 2025-06-13 16:00:00  1.15162  1.15646  1.145328   

                exit_ts      exit   pips       pl  equity_after  
325 2025-06-11 21:02:00  1.149910 -56.20 -27500.0   698672.6221  
326 2025-06-12 01:57:00  1.150350 -21.00 -10800.0   687872.6221  
327 2025-06-12 11:15:00  1.153320 -18.10  -9350.0   678522.6221  
328 2025-06-13 13:47:00  1.149875  77.35  38600.0   717122.6221  
329 2025-06-13 18:31:00  1.156460 -48.40 -24500.0   692622.6221
Initial Equity: 100
Final Equity: 692622.6220999856
</code></pre></div></div> <p><img src="/assets/proj/strategy_opt_files/equity_1.png" alt="eq_1" style="max-width: 100%; height: auto;"></p> <h2 id="stats">Stats</h2> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>

<span class="c1"># ────────────────────── DRAW-DOWN ──────────────────────
</span><span class="k">def</span> <span class="nf">_max_drawdown</span><span class="p">(</span><span class="n">equity_ser</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Returns (absolute drawdown in €, positive % drawdown).
    Calculation identical to the one used in the book / cTrader:
        DD% = equity / max(equity_to_date) - 1
    </span><span class="sh">"""</span>
    <span class="n">running_max</span> <span class="o">=</span> <span class="n">equity_ser</span><span class="p">.</span><span class="nf">cummax</span><span class="p">()</span>
    <span class="n">dd_pct_series</span> <span class="o">=</span> <span class="n">equity_ser</span> <span class="o">/</span> <span class="n">running_max</span> <span class="o">-</span> <span class="mf">1.0</span>      <span class="c1"># negative or zero
</span>    <span class="n">dd_abs_series</span> <span class="o">=</span> <span class="n">running_max</span> <span class="o">-</span> <span class="n">equity_ser</span>            <span class="c1"># €
</span>    <span class="n">dd_abs</span> <span class="o">=</span> <span class="nf">round</span><span class="p">(</span><span class="n">dd_abs_series</span><span class="p">.</span><span class="nf">max</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">dd_pct</span> <span class="o">=</span> <span class="nf">round</span><span class="p">(</span><span class="o">-</span><span class="n">dd_pct_series</span><span class="p">.</span><span class="nf">min</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dd_abs</span><span class="p">,</span> <span class="n">dd_pct</span>

<span class="c1"># ───────────────────────── HELPER ──────────────────────────
</span><span class="k">def</span> <span class="nf">_stats</span><span class="p">(</span><span class="n">trades</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">commission_per_lot</span><span class="p">,</span> <span class="n">swap_long</span><span class="p">,</span> <span class="n">swap_short</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">trades</span><span class="p">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">'</span><span class="s">label</span><span class="sh">'</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span> <span class="sh">'</span><span class="s">Trades</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

    <span class="c1"># commissions (if missing)
</span>    <span class="k">if</span> <span class="sh">'</span><span class="s">commission</span><span class="sh">'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="n">trades</span><span class="p">.</span><span class="nf">assign</span><span class="p">(</span><span class="n">commission</span><span class="o">=</span><span class="n">trades</span><span class="p">.</span><span class="n">lots</span> <span class="o">*</span> <span class="n">commission_per_lot</span><span class="p">)</span>

    <span class="c1"># swap (if missing → quick recalculation without 1-min loop)
</span>    <span class="k">if</span> <span class="sh">'</span><span class="s">swap</span><span class="sh">'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">trades</span><span class="p">.</span><span class="nb">dir</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">swap_long</span><span class="p">,</span> <span class="n">swap_short</span><span class="p">)</span>  <span class="c1"># €/lot/night
</span>        <span class="n">swap_cash</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">((</span><span class="n">trades</span><span class="p">.</span><span class="n">exit_ts</span><span class="p">.</span><span class="n">dt</span><span class="p">.</span><span class="nf">normalize</span><span class="p">()</span>            <span class="c1"># last day included?
</span>              <span class="o">-</span> <span class="p">(</span><span class="n">trades</span><span class="p">.</span><span class="n">entry_ts</span><span class="p">.</span><span class="n">dt</span><span class="p">.</span><span class="nf">normalize</span><span class="p">()</span> <span class="o">+</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
             <span class="p">.</span><span class="n">dt</span><span class="p">.</span><span class="n">days</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>                   <span class="c1"># full nights
</span>            <span class="p">.</span><span class="nf">add</span><span class="p">(</span>                                      <span class="c1"># triple Wednesday
</span>                <span class="p">((</span><span class="n">trades</span><span class="p">.</span><span class="n">exit_ts</span><span class="p">.</span><span class="n">dt</span><span class="p">.</span><span class="n">dayofweek</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>   <span class="c1"># exit on Wednesday?
</span>                 <span class="o">&amp;</span> <span class="p">(</span><span class="n">trades</span><span class="p">.</span><span class="n">exit_ts</span><span class="p">.</span><span class="n">dt</span><span class="p">.</span><span class="nf">normalize</span><span class="p">()</span>
                    <span class="o">&gt;</span> <span class="n">trades</span><span class="p">.</span><span class="n">entry_ts</span><span class="p">.</span><span class="n">dt</span><span class="p">.</span><span class="nf">normalize</span><span class="p">()</span><span class="o">+</span><span class="n">pd</span><span class="p">.</span><span class="nc">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                 <span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">pt</span> <span class="o">*</span> <span class="n">trades</span><span class="p">.</span><span class="n">lots</span>
        <span class="p">)</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="n">trades</span><span class="p">.</span><span class="nf">assign</span><span class="p">(</span><span class="n">swap</span><span class="o">=</span><span class="n">swap_cash</span><span class="p">)</span>

    <span class="n">gross_prof</span> <span class="o">=</span> <span class="n">trades</span><span class="p">.</span><span class="n">pl</span><span class="p">[</span><span class="n">trades</span><span class="p">.</span><span class="n">pl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">].</span><span class="nf">sum</span><span class="p">()</span>
    <span class="n">gross_loss</span> <span class="o">=</span> <span class="n">trades</span><span class="p">.</span><span class="n">pl</span><span class="p">[</span><span class="n">trades</span><span class="p">.</span><span class="n">pl</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">].</span><span class="nf">sum</span><span class="p">()</span>
    <span class="n">pf</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">inf</span> <span class="k">if</span> <span class="n">gross_loss</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">gross_prof</span> <span class="o">/</span> <span class="nf">abs</span><span class="p">(</span><span class="n">gross_loss</span><span class="p">)</span>

    <span class="n">wins</span>   <span class="o">=</span> <span class="n">trades</span><span class="p">.</span><span class="n">pl</span><span class="p">.</span><span class="nf">gt</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">sum</span><span class="p">()</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="n">trades</span><span class="p">.</span><span class="n">pl</span><span class="p">.</span><span class="nf">lt</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">sum</span><span class="p">()</span>
    <span class="n">avg_tr</span> <span class="o">=</span> <span class="n">trades</span><span class="p">.</span><span class="n">pl</span><span class="p">.</span><span class="nf">mean</span><span class="p">()</span>

    <span class="n">consec_w</span> <span class="o">=</span> <span class="n">trades</span><span class="p">.</span><span class="n">pl</span><span class="p">.</span><span class="nf">gt</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">).</span><span class="nf">groupby</span><span class="p">(</span>
               <span class="p">(</span><span class="n">trades</span><span class="p">.</span><span class="n">pl</span><span class="p">.</span><span class="nf">gt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">trades</span><span class="p">.</span><span class="n">pl</span><span class="p">.</span><span class="nf">gt</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">shift</span><span class="p">()).</span><span class="nf">cumsum</span><span class="p">()).</span><span class="nf">cumsum</span><span class="p">()</span>
    <span class="n">consec_l</span> <span class="o">=</span> <span class="n">trades</span><span class="p">.</span><span class="n">pl</span><span class="p">.</span><span class="nf">lt</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">).</span><span class="nf">groupby</span><span class="p">(</span>
               <span class="p">(</span><span class="n">trades</span><span class="p">.</span><span class="n">pl</span><span class="p">.</span><span class="nf">lt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">trades</span><span class="p">.</span><span class="n">pl</span><span class="p">.</span><span class="nf">lt</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">shift</span><span class="p">()).</span><span class="nf">cumsum</span><span class="p">()).</span><span class="nf">cumsum</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">label</span><span class="sh">'</span>           <span class="p">:</span> <span class="n">label</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Trades</span><span class="sh">'</span>          <span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">trades</span><span class="p">),</span>
        <span class="sh">'</span><span class="s">Net profit €</span><span class="sh">'</span>    <span class="p">:</span> <span class="nf">round</span><span class="p">(</span><span class="n">trades</span><span class="p">.</span><span class="n">pl</span><span class="p">.</span><span class="nf">sum</span><span class="p">(),</span> <span class="mi">2</span><span class="p">),</span>
        <span class="sh">'</span><span class="s">Profit factor</span><span class="sh">'</span>   <span class="p">:</span> <span class="nf">round</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="sh">'</span><span class="s">Commission €</span><span class="sh">'</span>    <span class="p">:</span> <span class="nf">round</span><span class="p">(</span><span class="n">trades</span><span class="p">[</span><span class="sh">'</span><span class="s">commission</span><span class="sh">'</span><span class="p">].</span><span class="nf">sum</span><span class="p">(),</span> <span class="mi">2</span><span class="p">),</span>
        <span class="sh">'</span><span class="s">Swap €</span><span class="sh">'</span>          <span class="p">:</span> <span class="nf">round</span><span class="p">(</span><span class="n">trades</span><span class="p">[</span><span class="sh">'</span><span class="s">swap</span><span class="sh">'</span><span class="p">].</span><span class="nf">sum</span><span class="p">(),</span> <span class="mi">2</span><span class="p">),</span>
        <span class="sh">'</span><span class="s">Winners</span><span class="sh">'</span>         <span class="p">:</span> <span class="n">wins</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Losers</span><span class="sh">'</span>          <span class="p">:</span> <span class="n">losses</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Max consec win</span><span class="sh">'</span>  <span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">consec_w</span><span class="p">.</span><span class="nf">max</span><span class="p">()),</span>
        <span class="sh">'</span><span class="s">Max consec loss</span><span class="sh">'</span> <span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">consec_l</span><span class="p">.</span><span class="nf">max</span><span class="p">()),</span>
        <span class="sh">'</span><span class="s">Largest win €</span><span class="sh">'</span>   <span class="p">:</span> <span class="nf">round</span><span class="p">(</span><span class="n">trades</span><span class="p">.</span><span class="n">pl</span><span class="p">.</span><span class="nf">max</span><span class="p">(),</span> <span class="mi">2</span><span class="p">),</span>
        <span class="sh">'</span><span class="s">Largest loss €</span><span class="sh">'</span>  <span class="p">:</span> <span class="nf">round</span><span class="p">(</span><span class="n">trades</span><span class="p">.</span><span class="n">pl</span><span class="p">.</span><span class="nf">min</span><span class="p">(),</span> <span class="mi">2</span><span class="p">),</span>
        <span class="sh">'</span><span class="s">Avg trade €</span><span class="sh">'</span>     <span class="p">:</span> <span class="nf">round</span><span class="p">(</span><span class="n">avg_tr</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">}</span>

<span class="c1"># ───────────────────── MAIN FUNCTION ────────────────────────
</span><span class="k">def</span> <span class="nf">full_stats</span><span class="p">(</span><span class="n">trades_df</span><span class="p">,</span> <span class="n">equity_curve</span><span class="p">,</span>
               <span class="n">commission_per_lot</span><span class="o">=</span><span class="mf">6.0</span><span class="p">,</span>
               <span class="n">swap_long_eur</span><span class="o">=-</span><span class="mf">9.71</span><span class="p">,</span>
               <span class="n">swap_short_eur</span><span class="o">=</span><span class="mf">4.50</span><span class="p">):</span>

    <span class="n">long_tr</span>  <span class="o">=</span> <span class="n">trades_df</span><span class="p">[</span><span class="n">trades_df</span><span class="p">.</span><span class="nb">dir</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">short_tr</span> <span class="o">=</span> <span class="n">trades_df</span><span class="p">[</span><span class="n">trades_df</span><span class="p">.</span><span class="nb">dir</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nf">_stats</span><span class="p">(</span><span class="n">long_tr</span><span class="p">,</span>  <span class="sh">'</span><span class="s">Long</span><span class="sh">'</span><span class="p">,</span>  <span class="n">commission_per_lot</span><span class="p">,</span> <span class="n">swap_long_eur</span><span class="p">,</span> <span class="n">swap_short_eur</span><span class="p">),</span>
        <span class="nf">_stats</span><span class="p">(</span><span class="n">short_tr</span><span class="p">,</span> <span class="sh">'</span><span class="s">Short</span><span class="sh">'</span><span class="p">,</span> <span class="n">commission_per_lot</span><span class="p">,</span> <span class="n">swap_long_eur</span><span class="p">,</span> <span class="n">swap_short_eur</span><span class="p">),</span>
        <span class="nf">_stats</span><span class="p">(</span><span class="n">trades_df</span><span class="p">,</span><span class="sh">'</span><span class="s">Total</span><span class="sh">'</span><span class="p">,</span> <span class="n">commission_per_lot</span><span class="p">,</span> <span class="n">swap_long_eur</span><span class="p">,</span> <span class="n">swap_short_eur</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># drawdown
</span>    <span class="n">dd_abs</span><span class="p">,</span> <span class="n">dd_pct</span> <span class="o">=</span> <span class="nf">_max_drawdown</span><span class="p">(</span><span class="n">equity_curve</span><span class="p">[</span><span class="sh">'</span><span class="s">equity</span><span class="sh">'</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">Max absolute drawdown : </span><span class="si">{</span><span class="n">dd_abs</span><span class="si">:</span><span class="p">,.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> €</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Max percentage drawdown: </span><span class="si">{</span><span class="n">dd_pct</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> %</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">cols_order</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">Trades</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Net profit €</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Profit factor</span><span class="sh">'</span><span class="p">,</span>
                  <span class="sh">'</span><span class="s">Commission €</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Swap €</span><span class="sh">'</span><span class="p">,</span>
                  <span class="sh">'</span><span class="s">Winners</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Losers</span><span class="sh">'</span><span class="p">,</span>
                  <span class="sh">'</span><span class="s">Max consec win</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Max consec loss</span><span class="sh">'</span><span class="p">,</span>
                  <span class="sh">'</span><span class="s">Largest win €</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Largest loss €</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Avg trade €</span><span class="sh">'</span><span class="p">]</span>

    <span class="nf">return </span><span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
              <span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">label</span><span class="sh">'</span><span class="p">)</span>
              <span class="p">[</span><span class="n">cols_order</span><span class="p">])</span>

<span class="c1"># --------------------------- USAGE ----------------------------------
</span><span class="n">stats_df</span> <span class="o">=</span> <span class="nf">full_stats</span><span class="p">(</span><span class="n">trades_df</span><span class="p">,</span> <span class="n">equity_curve</span><span class="p">,</span>
                      <span class="n">commission_per_lot</span><span class="o">=</span><span class="mf">6.0</span><span class="p">,</span>
                      <span class="n">swap_long_eur</span><span class="o">=-</span><span class="mf">9.71</span><span class="p">,</span>
                      <span class="n">swap_short_eur</span><span class="o">=</span><span class="mf">4.50</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="n">stats_df</span><span class="p">)</span>

</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Max absolute drawdown : 126,557.00 €
Max percentage drawdown  : 68.53 %
       Trades  Net profit €  Profit factor  Commission €    Swap €  Winners  \
label                                                                         
Long      145     421206.77           2.43      18090.36 -17320.21       91   
Short     185     271315.85           1.43      24816.24  14836.95      103   
Total     330     692522.62           1.75      42906.60  -2483.26      194   

       Losers  Max consec win  Max consec loss  Largest win €  Largest loss €  \
label                                                                           
Long       54               5                4        54992.5        -34692.0   
Short      82               8                7        73175.0        -38775.0   
Total     136               7                7        73175.0        -38775.0   

       Avg trade €  
label               
Long       2904.87  
Short      1466.57  
Total      2098.55  
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ─────────────────── Functions ─────────────────────────────
</span>
<span class="k">def</span> <span class="nf">sharpe_function</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="mi">252</span><span class="p">):</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">returns</span><span class="p">.</span><span class="nf">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">timeframe</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">returns</span><span class="p">.</span><span class="nf">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">timeframe</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mean</span> <span class="o">/</span> <span class="n">std</span>

<span class="k">def</span> <span class="nf">sortino_function</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="mi">252</span><span class="p">):</span>
    <span class="n">downside</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">returns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">returns</span><span class="p">.</span><span class="nf">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">timeframe</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">downside</span><span class="p">.</span><span class="nf">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">timeframe</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mean</span> <span class="o">/</span> <span class="n">std</span>

<span class="k">def</span> <span class="nf">drawdown_function</span><span class="p">(</span><span class="n">returns</span><span class="p">):</span>
    <span class="n">cum_rets</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nf">cumprod</span><span class="p">()</span>
    <span class="n">running_max</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">maximum</span><span class="p">.</span><span class="nf">accumulate</span><span class="p">(</span><span class="n">cum_rets</span><span class="p">.</span><span class="nf">dropna</span><span class="p">())</span>
    <span class="n">running_max</span><span class="p">[</span><span class="n">running_max</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">cum_rets</span> <span class="o">/</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">drawdown</span>

<span class="k">def</span> <span class="nf">VaR_function</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">100000</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">theta</span><span class="p">)</span>
    <span class="n">sims</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">Simulations</span><span class="sh">"</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">sims</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="sh">"</span><span class="s">Simulations</span><span class="sh">"</span><span class="p">).</span><span class="n">iloc</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">cVaR_function</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">100000</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">theta</span><span class="p">)</span>
    <span class="n">sims</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">Simulations</span><span class="sh">"</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">sims</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="sh">"</span><span class="s">Simulations</span><span class="sh">"</span><span class="p">).</span><span class="n">iloc</span><span class="p">[:</span><span class="n">t</span><span class="p">].</span><span class="nf">mean</span><span class="p">().</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># ─────────────── Metrics ─────────────────────────
</span>
<span class="n">returns</span> <span class="o">=</span> <span class="n">portfolio</span><span class="p">[</span><span class="sh">'</span><span class="s">returns</span><span class="sh">'</span><span class="p">]</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">returns</span><span class="p">.</span><span class="nf">mean</span><span class="p">()</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">returns</span><span class="p">.</span><span class="nf">std</span><span class="p">()</span>

</code></pre></div></div> <h3 id="cumulative-returns">Cumulative returns</h3> <p><img src="/assets/proj/strategy_opt_files/cum_ret_1.png" alt="cumret_1" style="max-width: 100%; height: auto;"></p> <h3 id="sharpe-and-sortino-ratio">Sharpe and Sortino Ratio</h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Sharpe Ratio : </span><span class="si">{</span><span class="nf">sharpe_function</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Sortino Ratio: </span><span class="si">{</span><span class="nf">sortino_function</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sharpe Ratio : 2.6897
Sortino Ratio: 3.4151
</code></pre></div></div> <h3 id="drawdown">Drawdown</h3> <p><img src="/assets/proj/strategy_opt_files/drawdown.png" alt="drawdown" style="max-width: 100%; height: auto;"></p> <h3 id="var-and-cvar">VAR and CVAR</h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ─────────────── VAR and CVAR ───────────────────────────────
</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Daily VaR 5%: </span><span class="si">{</span><span class="nc">VaR_function</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">%</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Monthly VaR 5%: </span><span class="si">{</span><span class="nc">VaR_function</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">mu</span><span class="o">*</span><span class="mi">20</span><span class="p">,</span> <span class="n">sigma</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">%</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Annual VaR 5%: </span><span class="si">{</span><span class="nc">VaR_function</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">mu</span><span class="o">*</span><span class="mi">252</span><span class="p">,</span> <span class="n">sigma</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">%</span><span class="sh">"</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Daily CVaR 5%: </span><span class="si">{</span><span class="nf">cVaR_function</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">%</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Monthly CVaR 5%: </span><span class="si">{</span><span class="nf">cVaR_function</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">mu</span><span class="o">*</span><span class="mi">20</span><span class="p">,</span> <span class="n">sigma</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">%</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Annual CVaR 5%: </span><span class="si">{</span><span class="nf">cVaR_function</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">mu</span><span class="o">*</span><span class="mi">252</span><span class="p">,</span> <span class="n">sigma</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">%</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Daily VaR 5%: -12.86%
Monthly VaR 5%: -34.28%
Annual VaR 5%: 143.55%
Daily CVaR 5%: -16.39%
Monthly CVaR 5%: -50.91%
Annual CVaR 5%: 85.91%
</code></pre></div></div> <p>The results appear to be extremely good — could this indicate potential overfitting? To verify, we can perform a permutation test.</p> <h1 id="permutation-test">Permutation Test</h1> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ════════════════════════════════════════════════════════════════════════════
#  1.  DEFINISCI LO SPAZIO DEI PARAMETRI  (modifica a piacere)
# ════════════════════════════════════════════════════════════════════════════
</span><span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">sma1_window</span><span class="sh">'</span>   <span class="p">:</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">],</span>          <span class="c1"># 3 valori (include 15)
</span>    <span class="sh">'</span><span class="s">sma2_window</span><span class="sh">'</span>   <span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">],</span>          <span class="c1"># 3 valori (include 10)
</span>    <span class="sh">'</span><span class="s">adx_window</span><span class="sh">'</span>    <span class="p">:</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">55</span><span class="p">],</span>          <span class="c1"># 3 valori (include 55)
</span>    <span class="sh">'</span><span class="s">adx_max</span><span class="sh">'</span>       <span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mf">13.5</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span>        <span class="c1"># 3 valori (include 13.5)
</span>    <span class="sh">'</span><span class="s">risk_pct</span><span class="sh">'</span>      <span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span>           <span class="c1"># 3 valori (include 15)
</span>    <span class="sh">'</span><span class="s">extra_pips</span><span class="sh">'</span>    <span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">],</span>               <span class="c1"># 2 valori (include 4)
</span>    <span class="sh">'</span><span class="s">tp_multiplier</span><span class="sh">'</span> <span class="p">:</span> <span class="p">[</span><span class="mf">1.3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>        <span class="c1"># 4 valori (include 1.3)
</span><span class="p">}</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1) GENERA TUTTE LE COMBINAZIONI
</span><span class="n">param_combos</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">product</span><span class="p">(</span><span class="o">*</span><span class="n">param_grid</span><span class="p">.</span><span class="nf">values</span><span class="p">()))</span>
<span class="n">TOTAL_COMBOS</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">param_combos</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Totale combinazioni da testare: </span><span class="si">{</span><span class="n">TOTAL_COMBOS</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Totale combinazioni da testare: 972
</code></pre></div></div> <p>To use this type of test we must create a function that will backtest only on the H4 timeframe. The results will be slightly different but this is not so important since we just wanna know if our strategy is due to noise</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Backtest with only h4
</span>
<span class="c1"># ── PARAMETRI BASE ─────────────────────────────────────────────────────────
</span><span class="n">risk_pct</span>        <span class="o">=</span> <span class="mi">15</span>
<span class="n">extra_pips</span>      <span class="o">=</span> <span class="mi">4</span>
<span class="n">tp_multiplier</span>   <span class="o">=</span> <span class="mf">1.3</span>
<span class="n">pip_size</span>        <span class="o">=</span> <span class="mf">0.0001</span>
<span class="n">pip_value</span>       <span class="o">=</span> <span class="mi">10</span>
<span class="n">min_lot</span>         <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">max_lot</span>         <span class="o">=</span> <span class="mf">50.0</span>
<span class="n">leverage</span>        <span class="o">=</span> <span class="mi">500</span>
<span class="n">init_equity</span>     <span class="o">=</span> <span class="mi">100</span>

<span class="n">commission_per_lot</span> <span class="o">=</span> <span class="mf">6.0</span>
<span class="n">swap_long_eur</span>      <span class="o">=</span> <span class="o">-</span><span class="mf">9.71</span>
<span class="n">swap_short_eur</span>     <span class="o">=</span>  <span class="mf">4.50</span>

<span class="c1"># ── DATI ───────────────────────────────────────────────────────────────────
</span><span class="n">df</span> <span class="o">=</span> <span class="n">df_4h</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>  <span class="c1"># contiene già 'sma1', 'sma2', 'adx'
</span>
<span class="c1"># ── Segnali ───────────────────────────────────────────────────────────────
</span><span class="n">time_ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">hour</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">df</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">hour</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">minute</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">prev1</span><span class="p">,</span> <span class="n">prev2</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">df</span><span class="p">.</span><span class="nf">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">long_sig</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">prev1</span><span class="p">[</span><span class="sh">'</span><span class="s">sma1</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">prev1</span><span class="p">[</span><span class="sh">'</span><span class="s">sma2</span><span class="sh">'</span><span class="p">])</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">prev2</span><span class="p">[</span><span class="sh">'</span><span class="s">close</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">prev2</span><span class="p">[</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">])</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">prev1</span><span class="p">[</span><span class="sh">'</span><span class="s">close</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">prev1</span><span class="p">[</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">])</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">prev1</span><span class="p">[</span><span class="sh">'</span><span class="s">adx</span><span class="sh">'</span><span class="p">]</span>  <span class="o">&lt;</span> <span class="mf">13.5</span><span class="p">)</span> <span class="o">&amp;</span>
    <span class="n">time_ok</span>
<span class="p">)</span>
<span class="n">short_sig</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">prev1</span><span class="p">[</span><span class="sh">'</span><span class="s">sma1</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">prev1</span><span class="p">[</span><span class="sh">'</span><span class="s">sma2</span><span class="sh">'</span><span class="p">])</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">prev2</span><span class="p">[</span><span class="sh">'</span><span class="s">close</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">prev2</span><span class="p">[</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">])</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">prev1</span><span class="p">[</span><span class="sh">'</span><span class="s">close</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">prev1</span><span class="p">[</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">])</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">prev1</span><span class="p">[</span><span class="sh">'</span><span class="s">adx</span><span class="sh">'</span><span class="p">]</span>  <span class="o">&lt;</span> <span class="mf">13.5</span><span class="p">)</span> <span class="o">&amp;</span>
    <span class="n">time_ok</span>
<span class="p">)</span>

<span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">signal</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">long_sig</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">short_sig</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

<span class="c1"># ── FUNZIONI UTILI ─────────────────────────────────────────────────────────
</span><span class="k">def</span> <span class="nf">round_lot</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="nf">max</span><span class="p">(</span><span class="n">min_lot</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">min_lot</span><span class="p">)</span> <span class="o">*</span> <span class="n">min_lot</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">nightly_swap_cash</span><span class="p">(</span><span class="n">entry_ts</span><span class="p">,</span> <span class="n">exit_ts</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span> <span class="n">dir_</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Swap notturno complessivo (€) fra entry e exit (solo H4).</span><span class="sh">"""</span>
    <span class="n">first_night</span> <span class="o">=</span> <span class="n">entry_ts</span><span class="p">.</span><span class="nf">normalize</span><span class="p">()</span> <span class="o">+</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">last_night</span>  <span class="o">=</span> <span class="n">exit_ts</span><span class="p">.</span><span class="nf">normalize</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">exit_ts</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">==</span> <span class="n">pd</span><span class="p">.</span><span class="n">Timestamp</span><span class="p">.</span><span class="nb">min</span><span class="p">.</span><span class="nf">time</span><span class="p">():</span>
        <span class="n">last_night</span> <span class="o">-=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">first_night</span> <span class="o">&gt;</span> <span class="n">last_night</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="n">nights</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">date_range</span><span class="p">(</span><span class="n">first_night</span><span class="p">,</span> <span class="n">last_night</span><span class="p">,</span>
                           <span class="n">freq</span><span class="o">=</span><span class="sh">'</span><span class="s">D</span><span class="sh">'</span><span class="p">,</span> <span class="n">inclusive</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nights</span><span class="p">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="n">nightly_eur</span> <span class="o">=</span> <span class="n">swap_long_eur</span> <span class="k">if</span> <span class="n">dir_</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">swap_short_eur</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">nights</span><span class="p">:</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">nightly_eur</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">.</span><span class="n">dayofweek</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># mercoledì ⇒ +2 notti extra
</span>            <span class="n">total</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nightly_eur</span>
    <span class="k">return</span> <span class="n">total</span> <span class="o">*</span> <span class="n">lots</span>

<span class="c1"># ── LOOP SOLO H4 ───────────────────────────────────────────────────────────
</span><span class="n">equity</span>            <span class="o">=</span> <span class="n">init_equity</span>
<span class="n">open_trade</span>        <span class="o">=</span> <span class="bp">None</span>
<span class="n">blocked_until</span>     <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">Timestamp</span><span class="p">.</span><span class="nb">min</span>
<span class="n">trades</span><span class="p">,</span> <span class="n">curve</span>     <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">df</span><span class="p">)):</span>
    <span class="n">row</span><span class="p">,</span> <span class="n">prev1</span><span class="p">,</span> <span class="n">prev2</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="nf">if </span><span class="p">(</span><span class="n">row</span><span class="p">.</span><span class="n">name</span> <span class="o">&lt;</span> <span class="n">blocked_until</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">open_trade</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="sh">'</span><span class="s">signal</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">continue</span>

    <span class="n">dir_</span>     <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="sh">'</span><span class="s">signal</span><span class="sh">'</span><span class="p">])</span>
    <span class="n">entry_ts</span> <span class="o">=</span> <span class="n">row</span><span class="p">.</span><span class="n">name</span>
    <span class="n">entry_px</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">]</span>

    <span class="c1"># SL basato su 2 barre precedenti
</span>    <span class="n">sl_px</span> <span class="o">=</span> <span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">prev1</span><span class="p">[</span><span class="sh">'</span><span class="s">low</span><span class="sh">'</span><span class="p">],</span> <span class="n">prev2</span><span class="p">[</span><span class="sh">'</span><span class="s">low</span><span class="sh">'</span><span class="p">])</span> <span class="o">-</span> <span class="n">extra_pips</span> <span class="o">*</span> <span class="n">pip_size</span>
             <span class="k">if</span> <span class="n">dir_</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span>
             <span class="nf">max</span><span class="p">(</span><span class="n">prev1</span><span class="p">[</span><span class="sh">'</span><span class="s">high</span><span class="sh">'</span><span class="p">],</span> <span class="n">prev2</span><span class="p">[</span><span class="sh">'</span><span class="s">high</span><span class="sh">'</span><span class="p">])</span> <span class="o">+</span> <span class="n">extra_pips</span> <span class="o">*</span> <span class="n">pip_size</span><span class="p">)</span>
    <span class="n">sl_pips</span> <span class="o">=</span> <span class="nf">abs</span><span class="p">(</span><span class="n">entry_px</span> <span class="o">-</span> <span class="n">sl_px</span><span class="p">)</span> <span class="o">/</span> <span class="n">pip_size</span>
    <span class="k">if</span> <span class="n">sl_pips</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="c1"># Calcolo lotti
</span>    <span class="n">lots_risk</span> <span class="o">=</span> <span class="nf">round_lot</span><span class="p">((</span><span class="n">equity</span> <span class="o">*</span> <span class="n">risk_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sl_pips</span> <span class="o">*</span> <span class="n">pip_value</span><span class="p">))</span>
    <span class="n">lots_max_margin</span> <span class="o">=</span> <span class="nf">round_lot</span><span class="p">((</span><span class="n">equity</span> <span class="o">*</span> <span class="n">leverage</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">entry_px</span> <span class="o">*</span> <span class="mi">100_000</span><span class="p">))</span>
    <span class="n">lots</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">lots_risk</span><span class="p">,</span> <span class="n">lots_max_margin</span><span class="p">,</span> <span class="n">max_lot</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lots</span> <span class="o">&lt;</span> <span class="n">min_lot</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="n">tp_px</span> <span class="o">=</span> <span class="n">entry_px</span> <span class="o">+</span> <span class="n">dir_</span> <span class="o">*</span> <span class="n">sl_pips</span> <span class="o">*</span> <span class="n">pip_size</span> <span class="o">*</span> <span class="n">tp_multiplier</span>
    <span class="n">open_trade</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">dir_</span><span class="p">,</span>
                      <span class="n">entry_ts</span><span class="o">=</span><span class="n">entry_ts</span><span class="p">,</span> <span class="n">entry</span><span class="o">=</span><span class="n">entry_px</span><span class="p">,</span>
                      <span class="n">sl_px</span><span class="o">=</span><span class="n">sl_px</span><span class="p">,</span> <span class="n">tp_px</span><span class="o">=</span><span class="n">tp_px</span><span class="p">)</span>

    <span class="c1"># Controllo TP/SL sulle barre H4 successive
</span>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">df</span><span class="p">)):</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">bar</span><span class="p">.</span><span class="n">name</span>
        <span class="n">hit_tp</span> <span class="o">=</span> <span class="p">(</span><span class="n">dir_</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">bar</span><span class="p">[</span><span class="sh">'</span><span class="s">high</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">tp_px</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dir_</span> <span class="o">==-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">bar</span><span class="p">[</span><span class="sh">'</span><span class="s">low</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">tp_px</span><span class="p">)</span>
        <span class="n">hit_sl</span> <span class="o">=</span> <span class="p">(</span><span class="n">dir_</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">bar</span><span class="p">[</span><span class="sh">'</span><span class="s">low</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">sl_px</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dir_</span> <span class="o">==-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">bar</span><span class="p">[</span><span class="sh">'</span><span class="s">high</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">sl_px</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">hit_tp</span> <span class="ow">or</span> <span class="n">hit_sl</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">exit_px</span>  <span class="o">=</span> <span class="n">tp_px</span> <span class="k">if</span> <span class="n">hit_tp</span> <span class="k">else</span> <span class="n">sl_px</span>
        <span class="n">pips</span>     <span class="o">=</span> <span class="p">(</span><span class="n">exit_px</span> <span class="o">-</span> <span class="n">entry_px</span><span class="p">)</span> <span class="o">/</span> <span class="n">pip_size</span> <span class="o">*</span> <span class="n">dir_</span>
        <span class="n">gross_pl</span> <span class="o">=</span> <span class="n">pips</span> <span class="o">*</span> <span class="n">lots</span> <span class="o">*</span> <span class="n">pip_value</span>

        <span class="n">commission</span> <span class="o">=</span> <span class="n">lots</span> <span class="o">*</span> <span class="n">commission_per_lot</span>
        <span class="n">swap_cash</span>  <span class="o">=</span> <span class="nf">nightly_swap_cash</span><span class="p">(</span><span class="n">entry_ts</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span> <span class="n">dir_</span><span class="p">)</span>

        <span class="n">pl_cash</span> <span class="o">=</span> <span class="n">gross_pl</span> <span class="o">-</span> <span class="n">commission</span> <span class="o">+</span> <span class="n">swap_cash</span>
        <span class="n">equity</span> <span class="o">+=</span> <span class="n">pl_cash</span>

        <span class="n">trades</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="o">**</span><span class="n">open_trade</span><span class="p">,</span>
                       <span class="sh">'</span><span class="s">exit_ts</span><span class="sh">'</span><span class="p">:</span> <span class="n">ts</span><span class="p">,</span> <span class="sh">'</span><span class="s">exit</span><span class="sh">'</span><span class="p">:</span> <span class="n">exit_px</span><span class="p">,</span>
                       <span class="sh">'</span><span class="s">pips</span><span class="sh">'</span><span class="p">:</span> <span class="n">pips</span><span class="p">,</span> <span class="sh">'</span><span class="s">pl</span><span class="sh">'</span><span class="p">:</span> <span class="n">pl_cash</span><span class="p">,</span>
                       <span class="sh">'</span><span class="s">equity_after</span><span class="sh">'</span><span class="p">:</span> <span class="n">equity</span><span class="p">})</span>
        <span class="n">curve</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">ts</span><span class="p">,</span> <span class="n">equity</span><span class="p">))</span>

        <span class="n">open_trade</span>    <span class="o">=</span> <span class="bp">None</span>
        <span class="n">blocked_until</span> <span class="o">=</span> <span class="n">ts</span>
        <span class="k">break</span>

    <span class="k">if</span> <span class="n">equity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Equity azzerata – stop back-test</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">break</span>

<span class="c1"># ── RISULTATI ──────────────────────────────────────────────────────────────
</span><span class="n">trades_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span>
<span class="n">equity_curve</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">curve</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">equity</span><span class="sh">'</span><span class="p">])</span>
                <span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">sort_index</span><span class="p">())</span>

<span class="nf">print</span><span class="p">(</span><span class="n">trades_df</span><span class="p">.</span><span class="nf">tail</span><span class="p">())</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Equity finale:</span><span class="sh">"</span><span class="p">,</span> <span class="n">equity</span><span class="p">)</span>

</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     lots  dir            entry_ts    entry    sl_px     tp_px  \
351  50.0   -1 2025-06-06 00:00:00  1.14429  1.14991  1.136984   
352  50.0   -1 2025-06-12 00:00:00  1.14825  1.15035  1.145520   
353  50.0   -1 2025-06-12 08:00:00  1.15151  1.15332  1.149157   
354  50.0   -1 2025-06-12 20:00:00  1.15761  1.16356  1.149875   
355  50.0   -1 2025-06-13 16:00:00  1.15162  1.15646  1.145328   

                exit_ts      exit   pips       pl  equity_after  
351 2025-06-11 20:00:00  1.149910 -56.20 -27500.0   781837.4761  
352 2025-06-12 04:00:00  1.150350 -21.00 -10800.0   771037.4761  
353 2025-06-12 12:00:00  1.153320 -18.10  -9350.0   761687.4761  
354 2025-06-13 12:00:00  1.149875  77.35  38600.0   800287.4761  
355 2025-06-16 08:00:00  1.156460 -48.40 -24050.0   776237.4761  
Equity finale: 776237.4760999826
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ── PLOT EQUITY ─────────────────────────────────────────────────────────────
</span><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dpi</span> <span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">equity_curve</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">equity_curve</span><span class="p">[</span><span class="sh">'</span><span class="s">equity</span><span class="sh">'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Equity H4</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Equity Curve (Backtest Only H4)</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Equity (€)</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">grid</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div> <p><img src="opt_2_files/opt_2_34_0.png" alt="png"></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span><span class="p">,</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span><span class="p">,</span> <span class="n">matplotlib</span><span class="p">.</span><span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">itertools</span>  <span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span> <span class="n">joblib</span>     <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span><span class="p">,</span> <span class="n">cpu_count</span><span class="p">,</span> <span class="n">parallel</span>
<span class="kn">from</span> <span class="n">tqdm</span>       <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="n">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>

<span class="c1"># ════════════════════════  CONFIG  ═══════════════════════════
</span><span class="n">N_PERMUTATIONS</span>   <span class="o">=</span> <span class="mi">1_000</span>        <span class="c1"># numero di permutazioni
</span><span class="n">MAX_PLOT_CURVES</span>  <span class="o">=</span> <span class="mi">1_000</span>          <span class="c1"># quante curve-equity mostrare
</span><span class="n">BATCH_SIZE_PAR</span>   <span class="o">=</span> <span class="mi">5</span>            <span class="c1"># batch_size per joblib
</span>
<span class="n">pip_size</span><span class="p">,</span> <span class="n">pip_value</span>       <span class="o">=</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mi">10</span>
<span class="n">min_lot</span><span class="p">,</span> <span class="n">max_lot</span>          <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">50.0</span>
<span class="n">leverage</span><span class="p">,</span> <span class="n">init_equity</span>     <span class="o">=</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">100</span>
<span class="n">commission_per_lot</span>        <span class="o">=</span> <span class="mf">6.0</span>
<span class="n">swap_long_eur</span><span class="p">,</span> <span class="n">swap_short_eur</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9.71</span><span class="p">,</span> <span class="mf">4.50</span>   <span class="c1"># BUY / SELL
</span>
<span class="c1"># griglia di ottimizzazione (ogni permutazione la userà)
</span><span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">sma1_window</span><span class="sh">"</span>  <span class="p">:</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">],</span>
    <span class="sh">"</span><span class="s">sma2_window</span><span class="sh">"</span>  <span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">],</span>
    <span class="sh">"</span><span class="s">adx_window</span><span class="sh">"</span>   <span class="p">:</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">55</span><span class="p">],</span>
    <span class="sh">"</span><span class="s">adx_max</span><span class="sh">"</span>      <span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mf">13.5</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span>
    <span class="sh">"</span><span class="s">risk_pct</span><span class="sh">"</span>     <span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span>
    <span class="sh">"</span><span class="s">extra_pips</span><span class="sh">"</span>   <span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">],</span>
    <span class="sh">"</span><span class="s">tp_multiplier</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">param_combos</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">product</span><span class="p">(</span><span class="o">*</span><span class="n">param_grid</span><span class="p">.</span><span class="nf">values</span><span class="p">()))</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Combinazioni per permutazione: </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">param_combos</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ════════════════════════  FUNZIONI  ═════════════════════════
</span><span class="k">def</span> <span class="nf">round_lot</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># arrotondamento lotti
</span>    <span class="k">return</span> <span class="nf">max</span><span class="p">(</span><span class="n">min_lot</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">min_lot</span><span class="p">)</span> <span class="o">*</span> <span class="n">min_lot</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">nightly_swap_cash</span><span class="p">(</span><span class="n">entry_ts</span><span class="p">,</span> <span class="n">exit_ts</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span> <span class="n">dir_</span><span class="p">):</span>
    <span class="n">entry_ts</span><span class="p">,</span> <span class="n">exit_ts</span> <span class="o">=</span> <span class="nf">map</span><span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="p">(</span><span class="n">entry_ts</span><span class="p">,</span> <span class="n">exit_ts</span><span class="p">))</span>
    <span class="n">fst</span> <span class="o">=</span> <span class="n">entry_ts</span><span class="p">.</span><span class="nf">normalize</span><span class="p">()</span> <span class="o">+</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">lst</span> <span class="o">=</span> <span class="n">exit_ts</span><span class="p">.</span><span class="nf">normalize</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="nc">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                 <span class="k">if</span> <span class="n">exit_ts</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">==</span><span class="n">pd</span><span class="p">.</span><span class="n">Timestamp</span><span class="p">.</span><span class="nb">min</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="k">else</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">fst</span> <span class="o">&gt;</span> <span class="n">lst</span><span class="p">:</span> <span class="k">return</span> <span class="mf">0.0</span>
    <span class="n">nights</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">date_range</span><span class="p">(</span><span class="n">fst</span><span class="p">,</span> <span class="n">lst</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="sh">"</span><span class="s">D</span><span class="sh">"</span><span class="p">,</span> <span class="n">inclusive</span><span class="o">=</span><span class="sh">"</span><span class="s">left</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">nightly</span> <span class="o">=</span> <span class="n">swap_long_eur</span> <span class="k">if</span> <span class="n">dir_</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">swap_short_eur</span>
    <span class="n">extra</span>   <span class="o">=</span> <span class="p">(</span><span class="n">nights</span><span class="p">.</span><span class="n">dayofweek</span> <span class="o">==</span> <span class="mi">2</span><span class="p">).</span><span class="nf">sum</span><span class="p">()</span> <span class="o">*</span> <span class="n">nightly</span> <span class="o">*</span> <span class="mi">2</span>     <span class="c1"># mer → +2
</span>    <span class="nf">return </span><span class="p">(</span><span class="n">nights</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">nightly</span> <span class="o">+</span> <span class="n">extra</span><span class="p">)</span> <span class="o">*</span> <span class="n">lots</span>

<span class="c1"># back-test (con opzione curva)
</span><span class="k">def</span> <span class="nf">backtest_h4_numpy</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">sma1_w</span><span class="p">,</span> <span class="n">sma2_w</span><span class="p">,</span> <span class="n">adx_w</span><span class="p">,</span>
                      <span class="n">adx_max</span><span class="p">,</span> <span class="n">risk_pct</span><span class="p">,</span> <span class="n">extra_pips</span><span class="p">,</span> <span class="n">tp_mult</span><span class="p">,</span>
                      <span class="n">return_curve</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="n">open_</span><span class="p">,</span> <span class="n">high_</span><span class="p">,</span> <span class="n">low_</span><span class="p">,</span> <span class="n">close_</span><span class="p">,</span> <span class="n">adx_</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">values</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span>
                                        <span class="p">(</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">high</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">low</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">close</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">adx</span><span class="sh">"</span><span class="p">)]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">sma1</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Series</span><span class="p">(</span><span class="n">close_</span><span class="p">).</span><span class="nf">rolling</span><span class="p">(</span><span class="n">sma1_w</span><span class="p">).</span><span class="nf">mean</span><span class="p">().</span><span class="nf">to_numpy</span><span class="p">()</span>
    <span class="n">sma2</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Series</span><span class="p">(</span><span class="n">close_</span><span class="p">).</span><span class="nf">rolling</span><span class="p">(</span><span class="n">sma2_w</span><span class="p">).</span><span class="nf">mean</span><span class="p">().</span><span class="nf">to_numpy</span><span class="p">()</span>
    <span class="n">adx</span>  <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Series</span><span class="p">(</span><span class="n">adx_</span> <span class="p">).</span><span class="nf">rolling</span><span class="p">(</span><span class="n">adx_w</span> <span class="p">).</span><span class="nf">mean</span><span class="p">().</span><span class="nf">to_numpy</span><span class="p">()</span>

    <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">maximum</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">maximum</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">ok_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">hour</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">df</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">hour</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">minute</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">long_sig</span>  <span class="o">=</span> <span class="p">((</span><span class="n">sma1</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sma2</span><span class="p">[</span><span class="n">p1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">close_</span><span class="p">[</span><span class="n">p2</span><span class="p">]</span><span class="o">&lt;</span><span class="n">open_</span><span class="p">[</span><span class="n">p2</span><span class="p">])</span> <span class="o">&amp;</span>
                 <span class="p">(</span><span class="n">close_</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">open_</span><span class="p">[</span><span class="n">p1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">adx</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">adx_max</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ok_time</span><span class="p">)</span>
    <span class="n">short_sig</span> <span class="o">=</span> <span class="p">((</span><span class="n">sma1</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sma2</span><span class="p">[</span><span class="n">p1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">close_</span><span class="p">[</span><span class="n">p2</span><span class="p">]</span><span class="o">&gt;</span><span class="n">open_</span><span class="p">[</span><span class="n">p2</span><span class="p">])</span> <span class="o">&amp;</span>
                 <span class="p">(</span><span class="n">close_</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">open_</span><span class="p">[</span><span class="n">p1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">adx</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">adx_max</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ok_time</span><span class="p">)</span>
    <span class="n">signal</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">long_sig</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">short_sig</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>

    <span class="n">equity</span><span class="p">,</span> <span class="n">block</span> <span class="o">=</span> <span class="n">init_equity</span><span class="p">,</span> <span class="n">pd</span><span class="p">.</span><span class="n">Timestamp</span><span class="p">.</span><span class="nb">min</span>
    <span class="k">if</span> <span class="n">return_curve</span><span class="p">:</span>
        <span class="n">curve_idx</span><span class="p">,</span> <span class="n">curve_val</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">equity</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ts</span> <span class="o">&lt;</span> <span class="n">block</span> <span class="ow">or</span> <span class="n">signal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">dir_</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">signal</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="n">ent_px</span><span class="o">=</span><span class="n">open_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">sl_px</span> <span class="o">=</span> <span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">low_</span><span class="p">[</span><span class="n">p1</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">low_</span><span class="p">[</span><span class="n">p2</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="o">-</span> <span class="n">extra_pips</span><span class="o">*</span><span class="n">pip_size</span>
                 <span class="k">if</span> <span class="n">dir_</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span>
                 <span class="nf">max</span><span class="p">(</span><span class="n">high_</span><span class="p">[</span><span class="n">p1</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">high_</span><span class="p">[</span><span class="n">p2</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="o">+</span> <span class="n">extra_pips</span><span class="o">*</span><span class="n">pip_size</span><span class="p">)</span>
        <span class="n">sl_pips</span> <span class="o">=</span> <span class="nf">abs</span><span class="p">(</span><span class="n">ent_px</span><span class="o">-</span><span class="n">sl_px</span><span class="p">)</span><span class="o">/</span><span class="n">pip_size</span>
        <span class="k">if</span> <span class="n">sl_pips</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">lots</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="nf">round_lot</span><span class="p">((</span><span class="n">equity</span><span class="o">*</span><span class="n">risk_pct</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sl_pips</span><span class="o">*</span><span class="n">pip_value</span><span class="p">)),</span>
                   <span class="nf">round_lot</span><span class="p">((</span><span class="n">equity</span><span class="o">*</span><span class="n">leverage</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ent_px</span><span class="o">*</span><span class="mi">100_000</span><span class="p">)),</span>
                   <span class="n">max_lot</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lots</span><span class="o">&lt;</span><span class="n">min_lot</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">tp_px</span> <span class="o">=</span> <span class="n">ent_px</span> <span class="o">+</span> <span class="n">dir_</span><span class="o">*</span><span class="n">sl_pips</span><span class="o">*</span><span class="n">pip_size</span><span class="o">*</span><span class="n">tp_mult</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="n">hit_tp</span> <span class="o">=</span> <span class="p">((</span><span class="n">dir_</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">high_</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">tp_px</span><span class="p">)</span> <span class="ow">or</span>
                      <span class="p">(</span><span class="n">dir_</span><span class="o">==-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">low_</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;=</span><span class="n">tp_px</span><span class="p">))</span>
            <span class="n">hit_sl</span> <span class="o">=</span> <span class="p">((</span><span class="n">dir_</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">low_</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;=</span><span class="n">sl_px</span><span class="p">)</span> <span class="ow">or</span>
                      <span class="p">(</span><span class="n">dir_</span><span class="o">==-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">high_</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">sl_px</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">hit_tp</span> <span class="ow">or</span> <span class="n">hit_sl</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">exit_px</span> <span class="o">=</span> <span class="n">tp_px</span> <span class="k">if</span> <span class="n">hit_tp</span> <span class="k">else</span> <span class="n">sl_px</span>
            <span class="n">pips</span>    <span class="o">=</span> <span class="p">(</span><span class="n">exit_px</span><span class="o">-</span><span class="n">ent_px</span><span class="p">)</span><span class="o">/</span><span class="n">pip_size</span><span class="o">*</span><span class="n">dir_</span>
            <span class="n">equity</span> <span class="o">+=</span> <span class="p">(</span><span class="n">pips</span><span class="o">*</span><span class="n">lots</span><span class="o">*</span><span class="n">pip_value</span> <span class="o">-</span>
                       <span class="n">lots</span><span class="o">*</span><span class="n">commission_per_lot</span> <span class="o">+</span>
                       <span class="nf">nightly_swap_cash</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">df</span><span class="p">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">lots</span><span class="p">,</span> <span class="n">dir_</span><span class="p">))</span>
            <span class="n">block</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">return_curve</span><span class="p">:</span>
                <span class="n">curve_idx</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">block</span><span class="p">);</span> <span class="n">curve_val</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">equity</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">equity</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span> <span class="k">break</span>

    <span class="k">if</span> <span class="n">return_curve</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">equity</span><span class="p">,</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Series</span><span class="p">(</span><span class="n">curve_val</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">curve_idx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">equity</span>

<span class="c1"># genera una permutazione
</span><span class="k">def</span> <span class="nf">get_permutation</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">n</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">df</span><span class="p">);</span> <span class="n">log</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">high</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">low</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">close</span><span class="sh">"</span><span class="p">]])</span>
    <span class="n">r_o</span><span class="o">=</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">]</span><span class="o">-</span><span class="n">log</span><span class="p">[</span><span class="sh">"</span><span class="s">close</span><span class="sh">"</span><span class="p">].</span><span class="nf">shift</span><span class="p">()).</span><span class="nf">to_numpy</span><span class="p">()</span>
    <span class="n">r_h</span><span class="o">=</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="sh">"</span><span class="s">high</span><span class="sh">"</span><span class="p">]</span><span class="o">-</span><span class="n">log</span><span class="p">[</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">]).</span><span class="nf">to_numpy</span><span class="p">()</span>
    <span class="n">r_l</span><span class="o">=</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="sh">"</span><span class="s">low</span><span class="sh">"</span> <span class="p">]</span><span class="o">-</span><span class="n">log</span><span class="p">[</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">]).</span><span class="nf">to_numpy</span><span class="p">()</span>
    <span class="n">r_c</span><span class="o">=</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="sh">"</span><span class="s">close</span><span class="sh">"</span><span class="p">]</span><span class="o">-</span><span class="n">log</span><span class="p">[</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">]).</span><span class="nf">to_numpy</span><span class="p">()</span>
    <span class="n">idx</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">);</span> <span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">permutation</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">permutation</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">perm</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">4</span><span class="p">));</span> <span class="n">perm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">log</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="n">perm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">perm</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">r_o</span><span class="p">[</span><span class="n">p2</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">perm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">perm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">r_h</span><span class="p">[</span><span class="n">p1</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">perm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">perm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">r_l</span><span class="p">[</span><span class="n">p1</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">perm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">perm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">r_c</span><span class="p">[</span><span class="n">p1</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">out</span><span class="o">=</span><span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="n">perm</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="p">.</span><span class="n">index</span><span class="p">,</span>
                     <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">high</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">low</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">close</span><span class="sh">"</span><span class="p">])</span>
    <span class="n">out</span><span class="p">[</span><span class="sh">"</span><span class="s">adx</span><span class="sh">"</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="sh">"</span><span class="s">adx</span><span class="sh">"</span><span class="p">].</span><span class="n">values</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="c1"># bridge tqdm ↔ joblib
</span><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">tqdm_joblib</span><span class="p">(</span><span class="n">tqdm_obj</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">_Batch</span><span class="p">(</span><span class="n">parallel</span><span class="p">.</span><span class="n">BatchCompletionCallBack</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="n">tqdm_obj</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">batch_size</span><span class="p">)</span>
            <span class="k">return</span> <span class="nf">super</span><span class="p">().</span><span class="nf">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">**</span><span class="n">k</span><span class="p">)</span>
    <span class="n">old</span> <span class="o">=</span> <span class="n">parallel</span><span class="p">.</span><span class="n">BatchCompletionCallBack</span>
    <span class="n">parallel</span><span class="p">.</span><span class="n">BatchCompletionCallBack</span> <span class="o">=</span> <span class="n">_Batch</span>
    <span class="k">try</span><span class="p">:</span>   <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span> <span class="n">parallel</span><span class="p">.</span><span class="n">BatchCompletionCallBack</span> <span class="o">=</span> <span class="n">old</span><span class="p">;</span> <span class="n">tqdm_obj</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="c1"># ═════════════════════  TEST PERMUTAZIONE  ══════════════════════
</span><span class="n">best_equity_real</span> <span class="o">=</span> <span class="n">equity</span>     <span class="c1"># già calcolata fuori da questa cella
</span><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Equity reale (già calcolata): </span><span class="si">{</span><span class="n">best_equity_real</span><span class="si">:</span><span class="p">,.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> €</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">run_perm</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">save_curve</span><span class="p">):</span>
    <span class="n">df_p</span> <span class="o">=</span> <span class="nf">get_permutation</span><span class="p">(</span><span class="n">df_4h</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">save_curve</span><span class="p">:</span>
        <span class="n">best_eq</span><span class="p">,</span> <span class="n">best_curve</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">inf</span><span class="p">,</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">cmb</span> <span class="ow">in</span> <span class="n">param_combos</span><span class="p">:</span>
            <span class="n">eq</span><span class="p">,</span> <span class="n">cv</span> <span class="o">=</span> <span class="nf">backtest_h4_numpy</span><span class="p">(</span><span class="n">df_p</span><span class="p">,</span> <span class="o">*</span><span class="n">cmb</span><span class="p">,</span> <span class="n">return_curve</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">eq</span> <span class="o">&gt;</span> <span class="n">best_eq</span><span class="p">:</span>
                <span class="n">best_eq</span><span class="p">,</span> <span class="n">best_curve</span> <span class="o">=</span> <span class="n">eq</span><span class="p">,</span> <span class="n">cv</span>
        <span class="k">return</span> <span class="n">best_eq</span><span class="p">,</span> <span class="n">best_curve</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">max</span><span class="p">(</span><span class="nf">backtest_h4_numpy</span><span class="p">(</span><span class="n">df_p</span><span class="p">,</span><span class="o">*</span><span class="n">cmb</span><span class="p">)</span> <span class="k">for</span> <span class="n">cmb</span> <span class="ow">in</span> <span class="n">param_combos</span><span class="p">)</span>

<span class="n">perm_equities</span><span class="p">,</span> <span class="n">perm_curves</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="k">with</span> <span class="nf">tqdm_joblib</span><span class="p">(</span><span class="nf">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">N_PERMUTATIONS</span><span class="p">,</span>
                      <span class="n">desc</span><span class="o">=</span><span class="sh">"</span><span class="s">Permutazioni</span><span class="sh">"</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">110</span><span class="p">))</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="nc">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="nf">max</span><span class="p">(</span><span class="nf">cpu_count</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                       <span class="n">backend</span><span class="o">=</span><span class="sh">"</span><span class="s">loky</span><span class="sh">"</span><span class="p">,</span>
                       <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE_PAR</span><span class="p">)(</span>
        <span class="nf">delayed</span><span class="p">(</span><span class="n">run_perm</span><span class="p">)(</span><span class="n">s</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">perm_curves</span><span class="p">)</span><span class="o">&lt;</span><span class="n">MAX_PLOT_CURVES</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N_PERMUTATIONS</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>

<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">eq</span><span class="p">,</span> <span class="n">cv</span> <span class="o">=</span> <span class="n">r</span>
        <span class="n">perm_curves</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">cv</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="n">r</span>
    <span class="n">perm_equities</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span>

<span class="n">p_value</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">([</span><span class="n">eq</span> <span class="o">&gt;=</span> <span class="n">best_equity_real</span> <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">perm_equities</span><span class="p">])</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">P-value ≈ </span><span class="si">{</span><span class="n">p_value</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">%</span><span class="sh">"</span><span class="p">)</span>

</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Combinazioni per permutazione: 972
Equity reale (già calcolata): 776,237.48 €


Permutazioni: 100%|█████████████████████████████████████████████████████| 1000/1000 [1:00:29&lt;00:00,  3.63s/it]

P-value ≈ 1.100%
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ------------------------------------------------------------------
#  Retrieve the real-strategy equity curve you already calculated
# ------------------------------------------------------------------
</span><span class="n">real_curve</span>       <span class="o">=</span> <span class="n">equity_curve</span><span class="p">[</span><span class="sh">"</span><span class="s">equity</span><span class="sh">"</span><span class="p">]</span>      <span class="c1"># Series: index=datetime, values=equity
</span><span class="n">best_equity_real</span> <span class="o">=</span> <span class="n">real_curve</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>         <span class="c1"># final equity value
</span>
<span class="c1"># ------------------------------------------------------------------
#  PLOT 1 – Equity curves over time
#          grey = each permuted optimisation
#          red  = your real strategy
# ------------------------------------------------------------------
</span><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

<span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="n">perm_curves</span><span class="p">:</span>                         <span class="c1"># collected inside the loop
</span>    <span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">cv</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cv</span><span class="p">.</span><span class="n">values</span><span class="p">,</span>
             <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">grey</span><span class="sh">"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">real_curve</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">real_curve</span><span class="p">.</span><span class="n">values</span><span class="p">,</span>
         <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">red</span><span class="sh">"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">Real equity</span><span class="sh">"</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Equity curves – permutations (grey) vs real (red)</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Date</span><span class="sh">"</span><span class="p">);</span> <span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Equity (€)</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">();</span> <span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

<span class="c1"># ------------------------------------------------------------------
#  PLOT 2 – Histogram of final equities
# ------------------------------------------------------------------
</span><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">perm_equities</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">grey</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">axvline</span><span class="p">(</span><span class="n">best_equity_real</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">red</span><span class="sh">"</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="sh">"</span><span class="s">--</span><span class="sh">"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">Real equity</span><span class="sh">"</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Distribution of best equities on permutations</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Final equity (€)</span><span class="sh">"</span><span class="p">);</span> <span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Frequency</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">();</span> <span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

</code></pre></div></div> <p><img src="opt_2_files/opt_2_36_0.png" alt="png"></p> <p><img src="opt_2_files/opt_2_36_1.png" alt="png"></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ──────────────────────────────────────────────────────────────────
# Helper: rebuild returns from an equity Series  ➜  cumulative paths
# ------------------------------------------------------------------
</span><span class="k">def</span> <span class="nf">build_return_paths</span><span class="p">(</span><span class="n">equity_series</span><span class="p">,</span> <span class="n">init_equity</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Parameters
    ----------
    equity_series : pd.Series
        Equity indexed by date (e.g. real_curve or a permuted curve).
    init_equity   : float
        Starting capital that the back-test used.

    Returns
    -------
    daily_ret     : pd.Series  (simple % returns)
    cum_ret       : pd.Series  (cumulative returns, base 0)
    log_cum_ret   : pd.Series  (log-cumulative returns, base 0)
    </span><span class="sh">"""</span>
    <span class="c1"># Insert the explicit initial balance on the very first bar
</span>    <span class="n">first_idx</span> <span class="o">=</span> <span class="n">equity_series</span><span class="p">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">equity_df</span> <span class="o">=</span> <span class="n">equity_series</span><span class="p">.</span><span class="nf">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">equity</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">equity_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">first_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">init_equity</span>          <span class="c1"># overwrite / ensure
</span>    <span class="n">equity_df</span> <span class="o">=</span> <span class="n">equity_df</span><span class="p">.</span><span class="nf">sort_index</span><span class="p">()</span>

    <span class="c1"># Simple % daily returns
</span>    <span class="n">daily_ret</span> <span class="o">=</span> <span class="n">equity_df</span><span class="p">[</span><span class="sh">'</span><span class="s">equity</span><span class="sh">'</span><span class="p">].</span><span class="nf">pct_change</span><span class="p">().</span><span class="nf">dropna</span><span class="p">()</span>

    <span class="c1"># Cumulative paths
</span>    <span class="n">cum_ret</span>     <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">daily_ret</span><span class="p">).</span><span class="nf">cumprod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">log_cum_ret</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">log1p</span><span class="p">(</span><span class="n">cum_ret</span><span class="p">)</span>                 <span class="c1"># ln(1 + cumulative)
</span>
    <span class="k">return</span> <span class="n">daily_ret</span><span class="p">,</span> <span class="n">cum_ret</span><span class="p">,</span> <span class="n">log_cum_ret</span>

</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Build paths for the real strategy
</span><span class="n">_</span><span class="p">,</span> <span class="n">real_cum</span><span class="p">,</span> <span class="n">real_log_cum</span> <span class="o">=</span> <span class="nf">build_return_paths</span><span class="p">(</span><span class="n">real_curve</span><span class="p">,</span> <span class="n">init_equity</span><span class="p">)</span>

<span class="c1"># Build paths for every permuted optimisation
</span><span class="n">perm_cum_paths</span><span class="p">,</span> <span class="n">perm_log_paths</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="n">perm_curves</span><span class="p">:</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">c_ret</span><span class="p">,</span> <span class="n">log_c_ret</span> <span class="o">=</span> <span class="nf">build_return_paths</span><span class="p">(</span><span class="n">cv</span><span class="p">,</span> <span class="n">init_equity</span><span class="p">)</span>
    <span class="n">perm_cum_paths</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">c_ret</span><span class="p">)</span>
    <span class="n">perm_log_paths</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">log_c_ret</span><span class="p">)</span>

</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
<span class="k">for</span> <span class="n">c_ret</span> <span class="ow">in</span> <span class="n">perm_cum_paths</span><span class="p">:</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">c_ret</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">c_ret</span><span class="p">.</span><span class="n">values</span><span class="p">,</span>
             <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">grey</span><span class="sh">"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">real_cum</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">real_cum</span><span class="p">.</span><span class="n">values</span><span class="p">,</span>
         <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">red</span><span class="sh">"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">Real strategy</span><span class="sh">"</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Cumulative returns – permutations (grey) vs real (red)</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Date</span><span class="sh">"</span><span class="p">);</span> <span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Cumulative return</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">black</span><span class="sh">"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">();</span> <span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

</code></pre></div></div> <p><img src="opt_2_files/opt_2_39_0.png" alt="png"></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
<span class="k">for</span> <span class="n">log_c_ret</span> <span class="ow">in</span> <span class="n">perm_log_paths</span><span class="p">:</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">log_c_ret</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">log_c_ret</span><span class="p">.</span><span class="n">values</span><span class="p">,</span>
             <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">grey</span><span class="sh">"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">real_log_cum</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">real_log_cum</span><span class="p">.</span><span class="n">values</span><span class="p">,</span>
         <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">red</span><span class="sh">"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">Real strategy</span><span class="sh">"</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Log-cumulative returns – permutations (grey) vs real (red)</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Date</span><span class="sh">"</span><span class="p">);</span> <span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Log cumulative return</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">black</span><span class="sh">"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">();</span> <span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

</code></pre></div></div> <p><img src="opt_2_files/opt_2_40_0.png" alt="png"></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ------------------------------------------------------------------
#  PLOT 1 – LOG Equity curves over time
#          grey = each permuted optimisation
#          red  = your real strategy
# ------------------------------------------------------------------
</span><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

<span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="n">perm_curves</span><span class="p">:</span>                         <span class="c1"># collected inside the loop
</span>    <span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">cv</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">cv</span><span class="p">.</span><span class="n">values</span><span class="p">),</span>
             <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">grey</span><span class="sh">"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">real_curve</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">real_curve</span><span class="p">.</span><span class="n">values</span><span class="p">),</span>
         <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">red</span><span class="sh">"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">Real equity</span><span class="sh">"</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Log - Equity curves – permutations (grey) vs real (red)</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Date</span><span class="sh">"</span><span class="p">);</span> <span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Equity (€)</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">();</span> <span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div> <p><img src="opt_2_files/opt_2_41_0.png" alt="png"></p> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Tommaso de Martino. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> </body> </html>